<template>
  <div class="container col-md-6">
    <!-- shooping list  -->
    <div class="d-flex justify-content-between">
      <p class="shopping-list"><i class="fas fa-shopping-basket mr-2"></i>Shopping List</p>
      <button class="btn btn-delete" @click="checkdelete"><i class="fas fa-trash-alt mr-2"></i>선택항목 삭제하기</button>
    </div>
    <div v-if="carts.length > 0">
      <div class="input-group mb-5" v-for="(post, index) in carts" :key="index">
        <div class="input-group-prepend">
          <div class="input-group-text">
            <input
              type="checkbox"
              aria-label="Checkbox for following text input"
              :value="post"
              v-model="checked"
              @click="changetf(index)"
            />
          </div>
        </div>
        <img :src="post.imgurl" alt="" @click="getdetail(post.pid)" />
        <div type="text" class="basket-list col-md-8" aria-label="Text input with checkbox" @click="getdetail(post.pid)">
          <p class="mb-0">제목 : {{ post.title }}</p>
          <p class="mb-0">기간 : {{ post.sdate }}~{{ post.edate }}</p>
          <p class="mb-0">위치 : {{ post.location }}</p>
          <p class="mb-0">가격 : {{ post.price }}</p>
          <!-- <p>{{checked}}</p> -->
        </div>
      </div>

      <!-- price -->
      <div>
        <p class="checked-price">Total : {{ checkedprice }}</p>
      </div>

      <!-- paging -->
      <b-pagination v-model="page" :total-rows="len" pills :per-page="8"></b-pagination>

      <!-- 구매하기 button -->
      <div class="d-flex justify-content-end mb-5">
        <button class="btn btn-danger" data-toggle="modal" data-target="#BasketPackingModal" @click="btnClick">
          <i class="far fa-hand-point-up mr-2"></i>패키징
        </button>
        <BasketPackingModal :prePosts="prePosts" />
      </div>
    </div>
  </div>
</template>

<script>
import axios from 'axios';
import '../../assets/css/basket.css';
import BasketPackingModal from '../../components/modal/BasketPackingModal.vue';
import BPagenation from 'bootstrap-vue';

import Swal from 'sweetalert2';

const baseURL = 'http://localhost:8080';

export default {
  components: {
    BPagenation,
    BasketPackingModal,
  },
  created() {
    this.authUser();
  },
  data() {
    return {
      page: 1,
      carts: {
        pid: '',
        email: '',
        activity: '',
        title: '',
        location: '',
        imgurl: '',
        price: '',
        sdate: '',
        edate: '',
        likecnt: '',
      },
      checked: [],
      sum: 0,
      likes: {
        no: '',
        pid: '',
        email: '',
        cart: '',
      },
      len: 0,
      no: {},
      temp: [],
      clicknum: 0,
      prePosts: [],
    };
  },
  methods: {
    btnClick() {
      this.temp = [];
      for (let i = 0; i < this.len; i++) {
        if (this.no[i] == 1) {
          this.temp.push(this.likes[i].no);
        }
      }

      axios
        .get(`${baseURL}/cart/preview/${this.temp}`)
        .then((res) => {
          this.prePosts = res.data;
        })
        .catch((err) => {
          console.log(err);
        });
    },
    changetf(index) {
      if (this.no[index] == null) {
        this.no[index] = 1;
      } else {
        this.no[index] = null;
      }
    },
    authUser() {
      axios
        .get(`${baseURL}/account/authuser/${this.$cookies.get('Auth-Token')}`)
        .then((response) => {
          this.email = response.data.email;
          this.init();
        })
        .catch((err) => {
          console.log(err.response);
        });
    },
    init() {
      axios
        .get(`${baseURL}/cart/list/${this.email}/${this.page}`)
        .then((res) => {
          this.carts = res.data;
        })
        .catch((err) => {
          console.log(err);
        });

      // likelist
      axios
        .get(`${baseURL}/cart/likelist/${this.email}`)
        .then((res) => {
          this.likes = res.data;
          this.len = this.likes.length;
        })
        .catch((err) => {
          console.log(err);
        });
    },
    getdetail(pid) {
      this.$router.push({
        name: 'PostListDetail',
        params: { ID: pid },
      });
    },
    checkPage() {
      axios
        .get(`${baseURL}/cart/list/${this.email}/${this.page}`)
        .then((res) => {
          this.carts = res.data;
        })
        .catch((err) => {
          console.log(err);
        });
      scroll(0, 0);
    },
    checkdelete() {
      this.btnClick();

      Swal.fire({
        width: 350,
        text: '선택항목을 삭제하시겠습니까?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: '<a style="font-size:1rem; color:black">Delete</a>',
        cancelButtonText: '<a style="font-size:1rem; color:black">Cancel</a>',
      }).then((result) => {
        if (result.value) {
          const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            onOpen: (toast) => {
              toast.addEventListener('mouseenter', Swal.stopTimer);
              toast.addEventListener('mouseleave', Swal.resumeTimer);
            },
          });
          Toast.fire({
            icon: 'success',
            title: '장바구니에서 삭제되었습니다.',
          });
          axios
            .delete(`${baseURL}/cart/delete/${this.temp}`)
            .then(() => {
              // this.$router.push(`/user/basket`);
              this.checked = [];
              this.init();
            })
            .catch((error) => {
              console.log(error.response.data);
            });
        }
      });
    },
  },
  computed: {
    checkedprice(price) {
      this.sum = 0;
      for (var i = 0; i < this.checked.length; i++) {
        this.sum += this.checked[i].price;
      }
      // console.log(this.sum)
      return this.sum;
    },
  },
  watch: {
    page: function(v) {
      this.checkPage();
    },
  },
};
</script>

<style></style>
